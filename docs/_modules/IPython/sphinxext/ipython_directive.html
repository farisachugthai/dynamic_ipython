
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>IPython.sphinxext.ipython_directive &#8212; Dynamic IPython: version0.0.2</title>
    <link rel="stylesheet" href="../../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="canonical" href="https://farisachugthai.github.io/dynamic-ipython/_modules/IPython/sphinxext/ipython_directive.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro" type="text/css"
  media="screen" charset="utf-8" />

<link rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Source+Code+Pro:regular,italic,bold,bolditalic" type="text/css" media="screen" charset="utf-8" />

<!--[if lte IE 6]>
<link rel="stylesheet" href="../../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->


  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Dynamic IPython</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for IPython.sphinxext.ipython_directive</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Sphinx directive to support embedded IPython code.</span>

<span class="sd">IPython provides an extension for `Sphinx &lt;http://www.sphinx-doc.org/&gt;`_ to</span>
<span class="sd">highlight and run code.</span>

<span class="sd">This directive allows pasting of entire interactive IPython sessions, prompts</span>
<span class="sd">and all, and their code will actually get re-executed at doc build time, with</span>
<span class="sd">all prompts renumbered sequentially. It also allows you to input code as a pure</span>
<span class="sd">python input by giving the argument python to the directive. The output looks</span>
<span class="sd">like an interactive ipython section.</span>

<span class="sd">Here is an example of how the IPython directive can</span>
<span class="sd">**run** python code, at build time.</span>

<span class="sd">.. ipython::</span>

<span class="sd">   In [1]: 1+1</span>

<span class="sd">   In [1]: import datetime</span>
<span class="sd">      ...: datetime.datetime.now()</span>

<span class="sd">It supports IPython construct that plain</span>
<span class="sd">Python does not understand (like magics):</span>

<span class="sd">.. ipython::</span>

<span class="sd">   In [0]: import time</span>

<span class="sd">   In [0]: %timeit time.sleep(0.05)</span>

<span class="sd">This will also support top-level async when using IPython 7.0+</span>

<span class="sd">.. ipython::</span>

<span class="sd">   In [2]: import asyncio</span>
<span class="sd">      ...: print(&#39;before&#39;)</span>
<span class="sd">      ...: await asyncio.sleep(1)</span>
<span class="sd">      ...: print(&#39;after&#39;)</span>


<span class="sd">The namespace will persist across multiple code chucks, Let&#39;s define a variable:</span>

<span class="sd">.. ipython::</span>

<span class="sd">   In [0]: who = &quot;World&quot;</span>

<span class="sd">And now say hello:</span>

<span class="sd">.. ipython::</span>

<span class="sd">   In [0]: print(&#39;Hello,&#39;, who)</span>

<span class="sd">If the current section raises an exception, you can add the ``:okexcept:`` flag</span>
<span class="sd">to the current block, otherwise the build will fail.</span>

<span class="sd">.. ipython::</span>
<span class="sd">   :okexcept:</span>

<span class="sd">   In [1]: 1/0</span>

<span class="sd">IPython Sphinx directive module</span>
<span class="sd">===============================</span>

<span class="sd">To enable this directive, simply list it in your Sphinx ``conf.py`` file</span>
<span class="sd">(making sure the directory where you placed it is visible to sphinx, as is</span>
<span class="sd">needed for all Sphinx directives). For example, to enable syntax highlighting</span>
<span class="sd">and the IPython directive::</span>

<span class="sd">    extensions = [&#39;IPython.sphinxext.ipython_console_highlighting&#39;,</span>
<span class="sd">                  &#39;IPython.sphinxext.ipython_directive&#39;]</span>

<span class="sd">The IPython directive outputs code-blocks with the language &#39;ipython&#39;. So</span>
<span class="sd">if you do not have the syntax highlighting extension enabled as well, then</span>
<span class="sd">all rendered code-blocks will be uncolored. By default this directive assumes</span>
<span class="sd">that your prompts are unchanged IPython ones, but this can be customized.</span>
<span class="sd">The configurable options that can be placed in conf.py are:</span>

<span class="sd">ipython_savefig_dir:</span>
<span class="sd">    The directory in which to save the figures. This is relative to the</span>
<span class="sd">    Sphinx source directory. The default is `html_static_path`.</span>
<span class="sd">ipython_rgxin:</span>
<span class="sd">    The compiled regular expression to denote the start of IPython input</span>
<span class="sd">    lines. The default is ``re.compile(&#39;In \\[(\\d+)\\]:\\s?(.*)\\s*&#39;)``. You</span>
<span class="sd">    shouldn&#39;t need to change this.</span>
<span class="sd">ipython_warning_is_error: [default to True]</span>
<span class="sd">    Fail the build if something unexpected happen, for example if a block raise</span>
<span class="sd">    an exception but does not have the `:okexcept:` flag. The exact behavior of</span>
<span class="sd">    what is considered strict, may change between the sphinx directive version.</span>
<span class="sd">ipython_rgxout:</span>
<span class="sd">    The compiled regular expression to denote the start of IPython output</span>
<span class="sd">    lines. The default is ``re.compile(&#39;Out\\[(\\d+)\\]:\\s?(.*)\\s*&#39;)``. You</span>
<span class="sd">    shouldn&#39;t need to change this.</span>
<span class="sd">ipython_promptin:</span>
<span class="sd">    The string to represent the IPython input prompt in the generated ReST.</span>
<span class="sd">    The default is ``&#39;In [%d]:&#39;``. This expects that the line numbers are used</span>
<span class="sd">    in the prompt.</span>
<span class="sd">ipython_promptout:</span>
<span class="sd">    The string to represent the IPython prompt in the generated ReST. The</span>
<span class="sd">    default is ``&#39;Out [%d]:&#39;``. This expects that the line numbers are used</span>
<span class="sd">    in the prompt.</span>
<span class="sd">ipython_mplbackend:</span>
<span class="sd">    The string which specifies if the embedded Sphinx shell should import</span>
<span class="sd">    Matplotlib and set the backend. The value specifies a backend that is</span>
<span class="sd">    passed to `matplotlib.use()` before any lines in `ipython_execlines` are</span>
<span class="sd">    executed. If not specified in conf.py, then the default value of &#39;agg&#39; is</span>
<span class="sd">    used. To use the IPython directive without matplotlib as a dependency, set</span>
<span class="sd">    the value to `None`. It may end up that matplotlib is still imported</span>
<span class="sd">    if the user specifies so in `ipython_execlines` or makes use of the</span>
<span class="sd">    @savefig pseudo decorator.</span>
<span class="sd">ipython_execlines:</span>
<span class="sd">    A list of strings to be exec&#39;d in the embedded Sphinx shell. Typical</span>
<span class="sd">    usage is to make certain packages always available. Set this to an empty</span>
<span class="sd">    list if you wish to have no imports always available. If specified in</span>
<span class="sd">    ``conf.py`` as `None`, then it has the effect of making no imports available.</span>
<span class="sd">    If omitted from conf.py altogether, then the default value of</span>
<span class="sd">    [&#39;import numpy as np&#39;, &#39;import matplotlib.pyplot as plt&#39;] is used.</span>
<span class="sd">ipython_holdcount</span>
<span class="sd">    When the @suppress pseudo-decorator is used, the execution count can be</span>
<span class="sd">    incremented or not. The default behavior is to hold the execution count,</span>
<span class="sd">    corresponding to a value of `True`. Set this to `False` to increment</span>
<span class="sd">    the execution count after each suppressed command.</span>

<span class="sd">As an example, to use the IPython directive when `matplotlib` is not available,</span>
<span class="sd">one sets the backend to `None`::</span>

<span class="sd">    ipython_mplbackend = None</span>

<span class="sd">An example usage of the directive is:</span>

<span class="sd">.. code-block:: rst</span>

<span class="sd">    .. ipython::</span>

<span class="sd">        In [1]: x = 1</span>

<span class="sd">        In [2]: y = x**2</span>

<span class="sd">        In [3]: print(y)</span>

<span class="sd">See http://matplotlib.org/sampledoc/ipython_directive.html for additional</span>
<span class="sd">documentation.</span>

<span class="sd">Pseudo-Decorators</span>
<span class="sd">=================</span>

<span class="sd">Note: Only one decorator is supported per input. If more than one decorator</span>
<span class="sd">is specified, then only the last one is used.</span>

<span class="sd">In addition to the Pseudo-Decorators/options described at the above link,</span>
<span class="sd">several enhancements have been made. The directive will emit a message to the</span>
<span class="sd">console at build-time if code-execution resulted in an exception or warning.</span>
<span class="sd">You can suppress these on a per-block basis by specifying the :okexcept:</span>
<span class="sd">or :okwarning: options:</span>

<span class="sd">.. code-block:: rst</span>

<span class="sd">    .. ipython::</span>
<span class="sd">        :okexcept:</span>
<span class="sd">        :okwarning:</span>

<span class="sd">        In [1]: 1/0</span>
<span class="sd">        In [2]: # raise warning.</span>

<span class="sd">To Do</span>
<span class="sd">=====</span>

<span class="sd">- Turn the ad-hoc test() function into a real test suite.</span>
<span class="sd">- Break up ipython-specific functionality from matplotlib stuff into better</span>
<span class="sd">  separated code.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Authors</span>
<span class="c1"># =======</span>
<span class="c1"># </span>
<span class="c1"># - John D Hunter: original author.</span>
<span class="c1"># - Fernando Perez: refactoring, documentation, cleanups, port to 0.11.</span>
<span class="c1"># - VáclavŠmilauer &lt;eudoxos-AT-arcig.cz&gt;: Prompt generalizations.</span>
<span class="c1"># - Skipper Seabold, refactoring, cleanups, pure python addition</span>

<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># Imports</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<span class="c1"># Stdlib</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="c1"># Third-party</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">directives</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Directive</span>

<span class="c1"># Our own</span>
<span class="kn">from</span> <span class="nn">traitlets.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">InteractiveShell</span>
<span class="kn">from</span> <span class="nn">IPython.core.profiledir</span> <span class="kn">import</span> <span class="n">ProfileDir</span>

<span class="n">use_matplotlib</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="n">use_matplotlib</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># Globals</span>
<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># for tokenizing blocks</span>
<span class="n">COMMENT</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">,</span> <span class="n">OUTPUT</span> <span class="o">=</span>  <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1">#-----------------------------------------------------------------------------</span>
<span class="c1"># Functions and class declarations</span>
<span class="c1">#-----------------------------------------------------------------------------</span>

<div class="viewcode-block" id="block_parser"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.block_parser">[docs]</a><span class="k">def</span> <span class="nf">block_parser</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">rgxin</span><span class="p">,</span> <span class="n">rgxout</span><span class="p">,</span> <span class="n">fmtin</span><span class="p">,</span> <span class="n">fmtout</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    part is a string of ipython text, comprised of at most one</span>
<span class="sd">    input, one output, comments, and blank lines.  The block parser</span>
<span class="sd">    parses the text into a list of::</span>

<span class="sd">      blocks = [ (TOKEN0, data0), (TOKEN1, data1), ...]</span>

<span class="sd">    where TOKEN is one of [COMMENT | INPUT | OUTPUT ] and</span>
<span class="sd">    data is, depending on the type of token::</span>

<span class="sd">      COMMENT : the comment string</span>

<span class="sd">      INPUT: the (DECORATOR, INPUT_LINE, REST) where</span>
<span class="sd">         DECORATOR: the input decorator (or None)</span>
<span class="sd">         INPUT_LINE: the input as string (possibly multi-line)</span>
<span class="sd">         REST : any stdout generated by the input line (not OUTPUT)</span>

<span class="sd">      OUTPUT: the output string, possibly multi-line</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">decorator</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">N</span><span class="p">:</span>
            <span class="c1"># nothing left to parse -- the last line</span>
            <span class="k">break</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">line_stripped</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line_stripped</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">COMMENT</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">line_stripped</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">):</span>
            <span class="c1"># Here is where we assume there is, at most, one decorator.</span>
            <span class="c1"># Might need to rethink this.</span>
            <span class="n">decorator</span> <span class="o">=</span> <span class="n">line_stripped</span>
            <span class="k">continue</span>

        <span class="c1"># does this look like an input line?</span>
        <span class="n">matchin</span> <span class="o">=</span> <span class="n">rgxin</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matchin</span><span class="p">:</span>
            <span class="n">lineno</span><span class="p">,</span> <span class="n">inputline</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matchin</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">matchin</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># the ....: continuation string</span>
            <span class="n">continuation</span> <span class="o">=</span> <span class="s1">&#39;   </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;.&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">))</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">Nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">continuation</span><span class="p">)</span>
            <span class="c1"># input lines can continue on for more than one line, if</span>
            <span class="c1"># we have a &#39;\&#39; line continuation char or a function call</span>
            <span class="c1"># echo line &#39;print&#39;.  The input line can only be</span>
            <span class="c1"># terminated by the end of the block or an output line, so</span>
            <span class="c1"># we parse out the rest of the input line if it is</span>
            <span class="c1"># multiline as well as any echo text</span>

            <span class="n">rest</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">:</span>

                <span class="c1"># look ahead; if the next line is blank, or a comment, or</span>
                <span class="c1"># an output line, we&#39;re done</span>

                <span class="n">nextline</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">matchout</span> <span class="o">=</span> <span class="n">rgxout</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">nextline</span><span class="p">)</span>
                <span class="c1">#print &quot;nextline=%s, continuation=%s, starts=%s&quot;%(nextline, continuation, nextline.startswith(continuation))</span>
                <span class="k">if</span> <span class="n">matchout</span> <span class="ow">or</span> <span class="n">nextline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">nextline</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">continuation</span><span class="p">):</span>
                    <span class="c1"># The default ipython_rgx* treat the space following the colon as optional.</span>
                    <span class="c1"># However, If the space is there we must consume it or code</span>
                    <span class="c1"># employing the cython_magic extension will fail to execute.</span>
                    <span class="c1">#</span>
                    <span class="c1"># This works with the default ipython_rgx* patterns,</span>
                    <span class="c1"># If you modify them, YMMV.</span>
                    <span class="n">nextline</span> <span class="o">=</span> <span class="n">nextline</span><span class="p">[</span><span class="n">Nc</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">nextline</span> <span class="ow">and</span> <span class="n">nextline</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39; &#39;</span><span class="p">:</span>
                        <span class="n">nextline</span> <span class="o">=</span> <span class="n">nextline</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                    <span class="n">inputline</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>  <span class="n">nextline</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rest</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nextline</span><span class="p">)</span>
                <span class="n">i</span><span class="o">+=</span> <span class="mi">1</span>

            <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">INPUT</span><span class="p">,</span> <span class="p">(</span><span class="n">decorator</span><span class="p">,</span> <span class="n">inputline</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rest</span><span class="p">))))</span>
            <span class="k">continue</span>

        <span class="c1"># if it looks like an output line grab all the text to the end</span>
        <span class="c1"># of the block</span>
        <span class="n">matchout</span> <span class="o">=</span> <span class="n">rgxout</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matchout</span><span class="p">:</span>
            <span class="n">lineno</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matchout</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">matchout</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">output</span><span class="p">]</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>

            <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">OUTPUT</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="n">block</span></div>


<div class="viewcode-block" id="EmbeddedSphinxShell"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell">[docs]</a><span class="k">class</span> <span class="nc">EmbeddedSphinxShell</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An embedded IPython instance to run inside Sphinx&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exec_lines</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cout</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">exec_lines</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">exec_lines</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Create config object for IPython</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">HistoryManager</span><span class="o">.</span><span class="n">hist_file</span> <span class="o">=</span> <span class="s1">&#39;:memory:&#39;</span>
        <span class="n">config</span><span class="o">.</span><span class="n">InteractiveShell</span><span class="o">.</span><span class="n">autocall</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">config</span><span class="o">.</span><span class="n">InteractiveShell</span><span class="o">.</span><span class="n">autoindent</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">config</span><span class="o">.</span><span class="n">InteractiveShell</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="s1">&#39;NoColor&#39;</span>

        <span class="c1"># create a profile so instance history isn&#39;t saved</span>
        <span class="n">tmp_profile_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;profile_&#39;</span><span class="p">)</span>
        <span class="n">profname</span> <span class="o">=</span> <span class="s1">&#39;auto_profile_sphinx_build&#39;</span>
        <span class="n">pdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_profile_dir</span><span class="p">,</span><span class="n">profname</span><span class="p">)</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">ProfileDir</span><span class="o">.</span><span class="n">create_profile_dir</span><span class="p">(</span><span class="n">pdir</span><span class="p">)</span>

        <span class="c1"># Create and initialize global ipython, but don&#39;t start its mainloop.</span>
        <span class="c1"># This will persist across different EmbeddedSphinxShell instances.</span>
        <span class="n">IP</span> <span class="o">=</span> <span class="n">InteractiveShell</span><span class="o">.</span><span class="n">instance</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">profile_dir</span><span class="o">=</span><span class="n">profile</span><span class="p">)</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>

        <span class="c1"># Store a few parts of IPython we&#39;ll need.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IP</span> <span class="o">=</span> <span class="n">IP</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">user_ns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_global_ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">user_global_ns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_profile_dir</span> <span class="o">=</span> <span class="n">tmp_profile_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_verbatim</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_doctest</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_suppress</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Optionally, provide more detailed information to shell.</span>
        <span class="c1"># this is assigned by the SetUp method of IPythonDirective</span>
        <span class="c1"># to point at itself.</span>
        <span class="c1">#</span>
        <span class="c1"># So, you can access handy things at self.directive.state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directive</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># on the first call to the savefig decorator, we&#39;ll import</span>
        <span class="c1"># pyplot as plt so we can make a call to the plt.gcf().savefig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pyplot_imported</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Prepopulate the namespace.</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">exec_lines</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_profile_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_cout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cout</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cout</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_input_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">store_history</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_input_lines</span><span class="p">([</span><span class="n">line</span><span class="p">],</span> <span class="n">store_history</span><span class="o">=</span><span class="n">store_history</span><span class="p">)</span>

<div class="viewcode-block" id="EmbeddedSphinxShell.process_input_lines"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.process_input_lines">[docs]</a>    <span class="k">def</span> <span class="nf">process_input_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;process the input, capturing stdout&quot;&quot;&quot;</span>
        <span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">source_raw</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cout</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">run_cell</span><span class="p">(</span><span class="n">source_raw</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="n">store_history</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span></div>

<div class="viewcode-block" id="EmbeddedSphinxShell.process_image"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.process_image">[docs]</a>    <span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decorator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # build out an image directive like</span>
<span class="sd">        # .. image:: somefile.png</span>
<span class="sd">        #    :width 4in</span>
<span class="sd">        #</span>
<span class="sd">        # from an input like</span>
<span class="sd">        # savefig somefile.png width=4in</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">savefig_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">savefig_dir</span>
        <span class="n">source_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_dir</span>
        <span class="n">saveargs</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">saveargs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># insert relative path to image file in source </span>
        <span class="c1"># as absolute path for Sphinx</span>
        <span class="c1"># sphinx expects a posix path, even on Windows</span>
        <span class="n">posix_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">savefig_dir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">posix_path</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span>

        <span class="n">imagerows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.. image:: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outfile</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">saveargs</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
            <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">kwarg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">imagerows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;   :</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

        <span class="n">image_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span> <span class="c1"># only return file name</span>
        <span class="n">image_directive</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imagerows</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_file</span><span class="p">,</span> <span class="n">image_directive</span></div>

    <span class="c1"># Callbacks for each type of token</span>
<div class="viewcode-block" id="EmbeddedSphinxShell.process_input"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.process_input">[docs]</a>    <span class="k">def</span> <span class="nf">process_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">input_prompt</span><span class="p">,</span> <span class="n">lineno</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process data block for INPUT token.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">decorator</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">image_directive</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">is_verbatim</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">==</span><span class="s1">&#39;@verbatim&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_verbatim</span>
        <span class="n">is_doctest</span> <span class="o">=</span> <span class="p">(</span><span class="n">decorator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                     <span class="n">decorator</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@doctest&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_doctest</span>
        <span class="n">is_suppress</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">==</span><span class="s1">&#39;@suppress&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_suppress</span>
        <span class="n">is_okexcept</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">==</span><span class="s1">&#39;@okexcept&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_okexcept</span>
        <span class="n">is_okwarning</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">==</span><span class="s1">&#39;@okwarning&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_okwarning</span>
        <span class="n">is_savefig</span> <span class="o">=</span> <span class="n">decorator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                     <span class="n">decorator</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@savefig&#39;</span><span class="p">)</span>

        <span class="n">input_lines</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">input_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># make sure there&#39;s a blank line</span>
                                       <span class="c1"># so splitter buffer gets reset</span>

        <span class="n">continuation</span> <span class="o">=</span> <span class="s1">&#39;   </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;.&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">))</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">is_savefig</span><span class="p">:</span>
            <span class="n">image_file</span><span class="p">,</span> <span class="n">image_directive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_image</span><span class="p">(</span><span class="n">decorator</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_semicolon</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># Hold the execution count, if requested to do so.</span>
        <span class="k">if</span> <span class="n">is_suppress</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hold_count</span><span class="p">:</span>
            <span class="n">store_history</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">store_history</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># Note: catch_warnings is not thread safe</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">ws</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                <span class="n">is_semicolon</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c1">#for i, line in enumerate(input_lines):</span>

            <span class="c1"># process the first input line</span>
            <span class="k">if</span> <span class="n">is_verbatim</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_input_lines</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">execution_count</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># increment it anyway</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># only submit the line in non-verbatim mode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_input_lines</span><span class="p">(</span><span class="n">input_lines</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="n">store_history</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_suppress</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_lines</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">formatted_line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">input_prompt</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">formatted_line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">continuation</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">formatted_line</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_suppress</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="ow">and</span> <span class="n">is_verbatim</span><span class="p">:</span>
            <span class="c1"># The &quot;rest&quot; is the standard output of the input. This needs to be</span>
            <span class="c1"># added when in verbatim mode. If there is no &quot;rest&quot;, then we don&#39;t</span>
            <span class="c1"># add it, as the new line will be added by the processed output.</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>

        <span class="c1"># Fetch the processed output. (This is not the submitted output.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cout</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">processed_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_suppress</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_semicolon</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># In IPythonDirective.run, the elements of `ret` are eventually</span>
            <span class="c1"># combined such that &#39;&#39; entries correspond to newlines. So if</span>
            <span class="c1"># `processed_output` is equal to &#39;&#39;, then the adding it to `ret`</span>
            <span class="c1"># ensures that there is a blank line between consecutive inputs</span>
            <span class="c1"># that have no outputs, as in:</span>
            <span class="c1">#</span>
            <span class="c1">#    In [1]: x = 4</span>
            <span class="c1">#</span>
            <span class="c1">#    In [2]: x = 5</span>
            <span class="c1">#</span>
            <span class="c1"># When there is processed output, it has a &#39;\n&#39; at the tail end. So</span>
            <span class="c1"># adding the output to `ret` will provide the necessary spacing</span>
            <span class="c1"># between consecutive input/output blocks, as in:</span>
            <span class="c1">#</span>
            <span class="c1">#   In [1]: x</span>
            <span class="c1">#   Out[1]: 5</span>
            <span class="c1">#</span>
            <span class="c1">#   In [2]: x</span>
            <span class="c1">#   Out[2]: 5</span>
            <span class="c1">#</span>
            <span class="c1"># When there is stdout from the input, it also has a &#39;\n&#39; at the</span>
            <span class="c1"># tail end, and so this ensures proper spacing as well. E.g.:</span>
            <span class="c1">#</span>
            <span class="c1">#   In [1]: print x</span>
            <span class="c1">#   5</span>
            <span class="c1">#</span>
            <span class="c1">#   In [2]: x = 5</span>
            <span class="c1">#</span>
            <span class="c1"># When in verbatim mode, `processed_output` is empty (because</span>
            <span class="c1"># nothing was passed to IP. Sometimes the submitted code block has</span>
            <span class="c1"># an Out[] portion and sometimes it does not. When it does not, we</span>
            <span class="c1"># need to ensure proper spacing, so we have to add &#39;&#39; to `ret`.</span>
            <span class="c1"># However, if there is an Out[] in the submitted code, then we do</span>
            <span class="c1"># not want to add a newline as `process_output` has stuff to add.</span>
            <span class="c1"># The difficulty is that `process_input` doesn&#39;t know if</span>
            <span class="c1"># `process_output` will be called---so it doesn&#39;t know if there is</span>
            <span class="c1"># Out[] in the code block. The requires that we include a hack in</span>
            <span class="c1"># `process_block`. See the comments there.</span>
            <span class="c1">#</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed_output</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_semicolon</span><span class="p">:</span>
            <span class="c1"># Make sure there is a newline after the semicolon.</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># context information</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_source</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_line</span>

        <span class="c1"># output any exceptions raised during execution to stdout</span>
        <span class="c1"># unless :okexcept: has been specified.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_okexcept</span> <span class="ow">and</span> <span class="p">((</span><span class="s2">&quot;Traceback&quot;</span> <span class="ow">in</span> <span class="n">processed_output</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;SyntaxError&quot;</span> <span class="ow">in</span> <span class="n">processed_output</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span>  <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Exception in </span><span class="si">%s</span><span class="s2"> at block ending on line </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Specify :okexcept: as an option in the ipython:: block to suppress this message</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&gt;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">73</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">processed_output</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;&lt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">73</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning_is_error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Non Expected exception in `{}` line {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">))</span>

        <span class="c1"># output any warning raised during execution to stdout</span>
        <span class="c1"># unless :okwarning: has been specified.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_okwarning</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">ws</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span>  <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning in </span><span class="si">%s</span><span class="s2"> at block ending on line </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Specify :okwarning: as an option in the ipython:: block to suppress this message</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&gt;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">73</span><span class="p">))</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">76</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">s</span><span class="o">=</span><span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
                                         <span class="n">w</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;&lt;&lt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">73</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warning_is_error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Non Expected warning in `{}` line {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cout</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">input_lines</span><span class="p">,</span> <span class="n">processed_output</span><span class="p">,</span>
                <span class="n">is_doctest</span><span class="p">,</span> <span class="n">decorator</span><span class="p">,</span> <span class="n">image_file</span><span class="p">,</span> <span class="n">image_directive</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmbeddedSphinxShell.process_output"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.process_output">[docs]</a>    <span class="k">def</span> <span class="nf">process_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">output_prompt</span><span class="p">,</span> <span class="n">input_lines</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span>
                       <span class="n">is_doctest</span><span class="p">,</span> <span class="n">decorator</span><span class="p">,</span> <span class="n">image_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process data block for OUTPUT token.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Recall: `data` is the submitted output, and `output` is the processed</span>
        <span class="c1"># output from `input_lines`.</span>

        <span class="n">TAB</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="n">is_doctest</span> <span class="ow">and</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

            <span class="n">found</span> <span class="o">=</span> <span class="n">output</span> <span class="c1"># This is the processed output</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">submitted</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;Unavailable&#39;</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;Unavailable&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_source</span>
                <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span><span class="o">.</span><span class="n">content</span>
                <span class="c1"># Add tabs and join into a single string.</span>
                <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">TAB</span> <span class="o">+</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="p">])</span>

            <span class="c1"># Make sure the output contains the output prompt.</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">found</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">output_prompt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;output does not contain output prompt</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;Document source: {0}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;Raw content: </span><span class="se">\n</span><span class="s1">{1}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;Input line(s):</span><span class="se">\n</span><span class="s1">{TAB}{2}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;Output line(s):</span><span class="se">\n</span><span class="s1">{TAB}{3}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_lines</span><span class="p">),</span>
                             <span class="nb">repr</span><span class="p">(</span><span class="n">found</span><span class="p">),</span> <span class="n">TAB</span><span class="o">=</span><span class="n">TAB</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">found</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">output_prompt</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Handle the actual doctest comparison.</span>
            <span class="k">if</span> <span class="n">decorator</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;@doctest&#39;</span><span class="p">:</span>
                <span class="c1"># Standard doctest</span>
                <span class="k">if</span> <span class="n">found</span> <span class="o">!=</span> <span class="n">submitted</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;doctest failure</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Document source: {0}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Raw content: </span><span class="se">\n</span><span class="s1">{1}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;On input line(s):</span><span class="se">\n</span><span class="s1">{TAB}{2}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;we found output:</span><span class="se">\n</span><span class="s1">{TAB}{3}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;instead of the expected:</span><span class="se">\n</span><span class="s1">{TAB}{4}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_lines</span><span class="p">),</span>
                                 <span class="nb">repr</span><span class="p">(</span><span class="n">found</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">submitted</span><span class="p">),</span> <span class="n">TAB</span><span class="o">=</span><span class="n">TAB</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">custom_doctest</span><span class="p">(</span><span class="n">decorator</span><span class="p">,</span> <span class="n">input_lines</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">submitted</span><span class="p">)</span>

        <span class="c1"># When in verbatim mode, this holds additional submitted output</span>
        <span class="c1"># to be written in the final Sphinx output.</span>
        <span class="c1"># https://github.com/ipython/ipython/issues/5776</span>
        <span class="n">out_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">is_verbatim</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">==</span><span class="s1">&#39;@verbatim&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_verbatim</span>
        <span class="k">if</span> <span class="n">is_verbatim</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="c1"># Note that `ret` in `process_block` has &#39;&#39; as its last element if</span>
            <span class="c1"># the code block was in verbatim mode. So if there is no submitted</span>
            <span class="c1"># output, then we will have proper spacing only if we do not add</span>
            <span class="c1"># an additional &#39;&#39; to `out_data`. This is why we condition on</span>
            <span class="c1"># `and data.strip()`.</span>

            <span class="c1"># The submitted output has no output prompt. If we want the</span>
            <span class="c1"># prompt and the code to appear, we need to join them now</span>
            <span class="c1"># instead of adding them separately---as this would create an</span>
            <span class="c1"># undesired newline. How we do this ultimately depends on the</span>
            <span class="c1"># format of the output regex. I&#39;ll do what works for the default</span>
            <span class="c1"># prompt for now, and we might have to adjust if it doesn&#39;t work</span>
            <span class="c1"># in other cases. Finally, the submitted output does not have</span>
            <span class="c1"># a trailing newline, so we must add it manually.</span>
            <span class="n">out_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;{0} {1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_prompt</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">out_data</span></div>

<div class="viewcode-block" id="EmbeddedSphinxShell.process_comment"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.process_comment">[docs]</a>    <span class="k">def</span> <span class="nf">process_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process data fPblock for COMMENT token.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_suppress</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span></div>

<div class="viewcode-block" id="EmbeddedSphinxShell.save_image"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.save_image">[docs]</a>    <span class="k">def</span> <span class="nf">save_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the image file to disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_pyplot</span><span class="p">()</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;plt.gcf().savefig(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span><span class="o">%</span><span class="n">image_file</span>
        <span class="c1">#print &#39;SAVEFIG&#39;, command  # dbg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="s1">&#39;bookmark ipy_thisdir&#39;</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="s1">&#39;cd -b ipy_savedir&#39;</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="s1">&#39;cd -b ipy_thisdir&#39;</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="s1">&#39;bookmark -d ipy_thisdir&#39;</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_cout</span><span class="p">()</span></div>

<div class="viewcode-block" id="EmbeddedSphinxShell.process_block"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.process_block">[docs]</a>    <span class="k">def</span> <span class="nf">process_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        process block from the block_parser and return a list of processed lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">input_lines</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">execution_count</span>

        <span class="n">input_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">promptin</span> <span class="o">%</span> <span class="n">lineno</span>
        <span class="n">output_prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">promptout</span> <span class="o">%</span> <span class="n">lineno</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">image_directive</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">found_input</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">block</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="n">COMMENT</span><span class="p">:</span>
                <span class="n">out_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_comment</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="n">INPUT</span><span class="p">:</span>
                <span class="n">found_input</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="p">(</span><span class="n">out_data</span><span class="p">,</span> <span class="n">input_lines</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">is_doctest</span><span class="p">,</span>
                 <span class="n">decorator</span><span class="p">,</span> <span class="n">image_file</span><span class="p">,</span> <span class="n">image_directive</span><span class="p">)</span> <span class="o">=</span> \
                          <span class="bp">self</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">input_prompt</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="n">OUTPUT</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found_input</span><span class="p">:</span>

                    <span class="n">TAB</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span>
                    <span class="n">linenumber</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;Unavailable&#39;</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;Unavailable&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span><span class="p">:</span>
                        <span class="n">linenumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_line</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_source</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directive</span><span class="o">.</span><span class="n">content</span>
                        <span class="c1"># Add tabs and join into a single string.</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">TAB</span> <span class="o">+</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="p">])</span>

                    <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Invalid block: Block contains an output prompt &#39;</span>
                         <span class="s1">&#39;without an input prompt.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Document source: {0}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Content begins at line {1}: </span><span class="se">\n\n</span><span class="s1">{2}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Problematic block within content: </span><span class="se">\n\n</span><span class="s1">{TAB}{3}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">linenumber</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">TAB</span><span class="o">=</span><span class="n">TAB</span><span class="p">)</span>

                    <span class="c1"># Write, rather than include in exception, since Sphinx</span>
                    <span class="c1"># will truncate tracebacks.</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;An invalid block was detected.&#39;</span><span class="p">)</span>
                <span class="n">out_data</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_output</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">output_prompt</span><span class="p">,</span> <span class="n">input_lines</span><span class="p">,</span>
                                        <span class="n">output</span><span class="p">,</span> <span class="n">is_doctest</span><span class="p">,</span> <span class="n">decorator</span><span class="p">,</span>
                                        <span class="n">image_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">out_data</span><span class="p">:</span>
                    <span class="c1"># Then there was user submitted output in verbatim mode.</span>
                    <span class="c1"># We need to remove the last element of `ret` that was</span>
                    <span class="c1"># added in `process_input`, as it is &#39;&#39; and would introduce</span>
                    <span class="c1"># an undesirable newline.</span>
                    <span class="k">assert</span><span class="p">(</span><span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">ret</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">out_data</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">out_data</span><span class="p">)</span>

        <span class="c1"># save the image files</span>
        <span class="k">if</span> <span class="n">image_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">image_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span><span class="p">,</span> <span class="n">image_directive</span></div>

<div class="viewcode-block" id="EmbeddedSphinxShell.ensure_pyplot"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.ensure_pyplot">[docs]</a>    <span class="k">def</span> <span class="nf">ensure_pyplot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensures that pyplot has been imported into the embedded IPython shell.</span>

<span class="sd">        Also, makes sure to set the backend appropriately if not set already.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We are here if the @figure pseudo decorator was used. Thus, it&#39;s</span>
        <span class="c1"># possible that we could be here even if python_mplbackend were set to</span>
        <span class="c1"># `None`. That&#39;s also strange and perhaps worthy of raising an</span>
        <span class="c1"># exception, but for now, we just set the backend to &#39;agg&#39;.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pyplot_imported</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;matplotlib.backends&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                <span class="c1"># Then ipython_matplotlib was set to None but there was a</span>
                <span class="c1"># call to the @figure decorator (and ipython_execlines did</span>
                <span class="c1"># not set a backend).</span>
                <span class="c1">#raise Exception(&quot;No backend was set, but @figure was used!&quot;)</span>
                <span class="kn">import</span> <span class="nn">matplotlib</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;agg&#39;</span><span class="p">)</span>

            <span class="c1"># Always import pyplot into embedded shell.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="s1">&#39;import matplotlib.pyplot as plt&#39;</span><span class="p">,</span>
                                    <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pyplot_imported</span> <span class="o">=</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="EmbeddedSphinxShell.process_pure_python"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.process_pure_python">[docs]</a>    <span class="k">def</span> <span class="nf">process_pure_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        content is a list of strings. it is unedited directive content</span>

<span class="sd">        This runs it line by line in the InteractiveShell, prepends</span>
<span class="sd">        prompts as needed capturing stderr and stdout, then returns</span>
<span class="sd">        the content as a list as if it were ipython code</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">savefig</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># keep up with this to clear figure</span>
        <span class="n">multiline</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># to handle line continuation</span>
        <span class="n">multiline_start</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">fmtin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">promptin</span>

        <span class="n">ct</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>

            <span class="n">line_stripped</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># handle decorators</span>
            <span class="k">if</span> <span class="n">line_stripped</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">line</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;savefig&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">savefig</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># and need to clear figure</span>
                <span class="k">continue</span>

            <span class="c1"># handle comments</span>
            <span class="k">if</span> <span class="n">line_stripped</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">line</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="c1"># deal with lines checking for multiline</span>
            <span class="n">continuation</span>  <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;   </span><span class="si">%s</span><span class="s1">:&#39;</span><span class="o">%</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;.&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">multiline</span><span class="p">:</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fmtin</span> <span class="o">%</span> <span class="n">ct</span><span class="p">,</span> <span class="n">line_stripped</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modified</span><span class="p">)</span>
                <span class="n">ct</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">line_stripped</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1"># on a multiline</span>
                    <span class="n">multiline</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">multiline_start</span> <span class="o">=</span> <span class="n">lineno</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># still on a multiline</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">continuation</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modified</span><span class="p">)</span>

                <span class="c1"># if the next line is indented, it should be part of multiline</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nextline</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nextline</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nextline</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">[</span><span class="n">multiline_start</span><span class="p">:</span><span class="n">lineno</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">FunctionDef</span><span class="p">):</span>
                        <span class="c1"># check to see if we have the whole function</span>
                        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">mod</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
                                <span class="n">multiline</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">multiline</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span> <span class="c1"># clear figure if plotted</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ensure_pyplot</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="s1">&#39;plt.clf()&#39;</span><span class="p">,</span> <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_cout</span><span class="p">()</span>
                <span class="n">savefig</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="EmbeddedSphinxShell.custom_doctest"><a class="viewcode-back" href="../../../sphinxext.html#IPython.sphinxext.ipython_directive.EmbeddedSphinxShell.custom_doctest">[docs]</a>    <span class="k">def</span> <span class="nf">custom_doctest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">decorator</span><span class="p">,</span> <span class="n">input_lines</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">submitted</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a specialized doctest.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.custom_doctests</span> <span class="kn">import</span> <span class="n">doctests</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">decorator</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">doctest_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">doctest_type</span> <span class="ow">in</span> <span class="n">doctests</span><span class="p">:</span>
            <span class="n">doctests</span><span class="p">[</span><span class="n">doctest_type</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">input_lines</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="n">submitted</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="s2">&quot;Invalid option to @doctest: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doctest_type</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">IPythonDirective</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>

    <span class="n">has_content</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">required_arguments</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">optional_arguments</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># python, suppress, verbatim, doctest</span>
    <span class="n">final_argumuent_whitespace</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">option_spec</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;python&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">unchanged</span><span class="p">,</span>
                    <span class="s1">&#39;suppress&#39;</span> <span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                    <span class="s1">&#39;verbatim&#39;</span> <span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                    <span class="s1">&#39;doctest&#39;</span> <span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                    <span class="s1">&#39;okexcept&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                    <span class="s1">&#39;okwarning&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">flag</span>
                  <span class="p">}</span>

    <span class="n">shell</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">seen_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_config_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># contains sphinx configuration variables</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">config</span>

        <span class="c1"># get config variables to set figure output directory</span>
        <span class="n">savefig_dir</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ipython_savefig_dir</span>
        <span class="n">source_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">srcdir</span>
        <span class="n">savefig_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">savefig_dir</span><span class="p">)</span>

        <span class="c1"># get regex and prompt stuff</span>
        <span class="n">rgxin</span>      <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ipython_rgxin</span>
        <span class="n">rgxout</span>     <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ipython_rgxout</span>
        <span class="n">warning_is_error</span><span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ipython_warning_is_error</span>
        <span class="n">promptin</span>   <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ipython_promptin</span>
        <span class="n">promptout</span>  <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ipython_promptout</span>
        <span class="n">mplbackend</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ipython_mplbackend</span>
        <span class="n">exec_lines</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ipython_execlines</span>
        <span class="n">hold_count</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">ipython_holdcount</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">savefig_dir</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">,</span> <span class="n">rgxin</span><span class="p">,</span> <span class="n">rgxout</span><span class="p">,</span>
                <span class="n">promptin</span><span class="p">,</span> <span class="n">promptout</span><span class="p">,</span> <span class="n">mplbackend</span><span class="p">,</span> <span class="n">exec_lines</span><span class="p">,</span> <span class="n">hold_count</span><span class="p">,</span> <span class="n">warning_is_error</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get configuration values.</span>
        <span class="p">(</span><span class="n">savefig_dir</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">,</span> <span class="n">rgxin</span><span class="p">,</span> <span class="n">rgxout</span><span class="p">,</span> <span class="n">promptin</span><span class="p">,</span> <span class="n">promptout</span><span class="p">,</span>
         <span class="n">mplbackend</span><span class="p">,</span> <span class="n">exec_lines</span><span class="p">,</span> <span class="n">hold_count</span><span class="p">,</span> <span class="n">warning_is_error</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_options</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">savefig_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># We will be here many times.  However, when the</span>
            <span class="c1"># EmbeddedSphinxShell is created, its interactive shell member</span>
            <span class="c1"># is the same for each instance.</span>

            <span class="k">if</span> <span class="n">mplbackend</span> <span class="ow">and</span> <span class="s1">&#39;matplotlib.backends&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span> <span class="ow">and</span> <span class="n">use_matplotlib</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">matplotlib</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">mplbackend</span><span class="p">)</span>

            <span class="c1"># Must be called after (potentially) importing matplotlib and</span>
            <span class="c1"># setting its backend since exec_lines might import pylab.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">EmbeddedSphinxShell</span><span class="p">(</span><span class="n">exec_lines</span><span class="p">)</span>

            <span class="c1"># Store IPython directive to enable better error messages</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">directive</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># reset the execution count if we haven&#39;t processed this doc</span>
        <span class="c1">#NOTE: this may be borked if there are multiple seen_doc tmp files</span>
        <span class="c1">#check time stamp?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">seen_docs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">history_manager</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">execution_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seen_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_source</span><span class="p">)</span>

        <span class="c1"># and attach to shell so we don&#39;t have to pass them around</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">rgxin</span> <span class="o">=</span> <span class="n">rgxin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">rgxout</span> <span class="o">=</span> <span class="n">rgxout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">promptin</span> <span class="o">=</span> <span class="n">promptin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">promptout</span> <span class="o">=</span> <span class="n">promptout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">savefig_dir</span> <span class="o">=</span> <span class="n">savefig_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">source_dir</span> <span class="o">=</span> <span class="n">source_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">hold_count</span> <span class="o">=</span> <span class="n">hold_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">warning_is_error</span> <span class="o">=</span> <span class="n">warning_is_error</span>

        <span class="c1"># setup bookmark for saving figures directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="s1">&#39;bookmark ipy_savedir </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">savefig_dir</span><span class="p">,</span>
                                      <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">clear_cout</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">rgxin</span><span class="p">,</span> <span class="n">rgxout</span><span class="p">,</span> <span class="n">promptin</span><span class="p">,</span> <span class="n">promptout</span>

    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># delete last bookmark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">process_input_line</span><span class="p">(</span><span class="s1">&#39;bookmark -d ipy_savedir&#39;</span><span class="p">,</span>
                                      <span class="n">store_history</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">clear_cout</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1">#TODO, any reason block_parser can&#39;t be a method of embeddable shell</span>
        <span class="c1"># then we wouldn&#39;t have to carry these around</span>
        <span class="n">rgxin</span><span class="p">,</span> <span class="n">rgxout</span><span class="p">,</span> <span class="n">promptin</span><span class="p">,</span> <span class="n">promptout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">is_suppress</span> <span class="o">=</span> <span class="s1">&#39;suppress&#39;</span> <span class="ow">in</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">is_doctest</span> <span class="o">=</span> <span class="s1">&#39;doctest&#39;</span> <span class="ow">in</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">is_verbatim</span> <span class="o">=</span> <span class="s1">&#39;verbatim&#39;</span> <span class="ow">in</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">is_okexcept</span> <span class="o">=</span> <span class="s1">&#39;okexcept&#39;</span> <span class="ow">in</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">is_okwarning</span> <span class="o">=</span> <span class="s1">&#39;okwarning&#39;</span> <span class="ow">in</span> <span class="n">options</span>

        <span class="c1"># handle pure python code</span>
        <span class="k">if</span> <span class="s1">&#39;python&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">process_pure_python</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="c1"># parts consists of all text within the ipython-block.</span>
        <span class="c1"># Each part is an input/output block.</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.. code-block:: ipython&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">figures</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">block_parser</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">rgxin</span><span class="p">,</span> <span class="n">rgxout</span><span class="p">,</span> <span class="n">promptin</span><span class="p">,</span> <span class="n">promptout</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
                <span class="n">rows</span><span class="p">,</span> <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">process_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;   {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)])</span>

                <span class="k">if</span> <span class="n">figure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Code input with no code at {}, line {}&#39;</span>\
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_source</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">current_line</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">warning_is_error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">figures</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">figure</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This has to do with input, not output. But if we comment</span>
                <span class="c1"># these lines out, then no IPython code will appear in the</span>
                <span class="c1"># final output.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">insert_input</span><span class="p">(</span>
                    <span class="n">lines</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machine</span><span class="o">.</span><span class="n">input_lines</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teardown</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[]</span>

<span class="c1"># Enable as a proper Sphinx directive</span>
<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">setup</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

    <span class="n">app</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s1">&#39;ipython&#39;</span><span class="p">,</span> <span class="n">IPythonDirective</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;ipython_savefig_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;savefig&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;ipython_warning_is_error&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;ipython_rgxin&#39;</span><span class="p">,</span>
                         <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;In \[(\d+)\]:\s?(.*)\s*&#39;</span><span class="p">),</span> <span class="s1">&#39;env&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;ipython_rgxout&#39;</span><span class="p">,</span>
                         <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Out\[(\d+)\]:\s?(.*)\s*&#39;</span><span class="p">),</span> <span class="s1">&#39;env&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;ipython_promptin&#39;</span><span class="p">,</span> <span class="s1">&#39;In [</span><span class="si">%d</span><span class="s1">]:&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;ipython_promptout&#39;</span><span class="p">,</span> <span class="s1">&#39;Out[</span><span class="si">%d</span><span class="s1">]:&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">)</span>

    <span class="c1"># We could just let matplotlib pick whatever is specified as the default</span>
    <span class="c1"># backend in the matplotlibrc file, but this would cause issues if the</span>
    <span class="c1"># backend didn&#39;t work in headless environments. For this reason, &#39;agg&#39;</span>
    <span class="c1"># is a good default backend choice.</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;ipython_mplbackend&#39;</span><span class="p">,</span> <span class="s1">&#39;agg&#39;</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">)</span>

    <span class="c1"># If the user sets this config value to `None`, then EmbeddedSphinxShell&#39;s</span>
    <span class="c1"># __init__ method will treat it as [].</span>
    <span class="n">execlines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import numpy as np&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">use_matplotlib</span><span class="p">:</span>
        <span class="n">execlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;import matplotlib.pyplot as plt&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;ipython_execlines&#39;</span><span class="p">,</span> <span class="n">execlines</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">add_config_value</span><span class="p">(</span><span class="s1">&#39;ipython_holdcount&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;env&#39;</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;parallel_read_safe&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;parallel_write_safe&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">metadata</span>

<span class="c1"># Simple smoke test, needs to be converted to a proper automatic test.</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>

    <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">In [9]: pwd</span>
<span class="sd">Out[9]: &#39;/home/jdhunter/py4science/book&#39;</span>

<span class="sd">In [10]: cd bookdata/</span>
<span class="sd">/home/jdhunter/py4science/book/bookdata</span>

<span class="sd">In [2]: from pylab import *</span>

<span class="sd">In [2]: ion()</span>

<span class="sd">In [3]: im = imread(&#39;stinkbug.png&#39;)</span>

<span class="sd">@savefig mystinkbug.png width=4in</span>
<span class="sd">In [4]: imshow(im)</span>
<span class="sd">Out[4]: &lt;matplotlib.image.AxesImage object at 0x39ea850&gt;</span>

<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">In [1]: x = &#39;hello world&#39;</span>

<span class="sd"># string methods can be</span>
<span class="sd"># used to alter the string</span>
<span class="sd">@doctest</span>
<span class="sd">In [2]: x.upper()</span>
<span class="sd">Out[2]: &#39;HELLO WORLD&#39;</span>

<span class="sd">@verbatim</span>
<span class="sd">In [3]: x.st&lt;TAB&gt;</span>
<span class="sd">x.startswith  x.strip</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">In [130]: url = &#39;http://ichart.finance.yahoo.com/table.csv?s=CROX\</span>
<span class="sd">   .....: &amp;d=9&amp;e=22&amp;f=2009&amp;g=d&amp;a=1&amp;br=8&amp;c=2006&amp;ignore=.csv&#39;</span>

<span class="sd">In [131]: print url.split(&#39;&amp;&#39;)</span>
<span class="sd">[&#39;http://ichart.finance.yahoo.com/table.csv?s=CROX&#39;, &#39;d=9&#39;, &#39;e=22&#39;, &#39;f=2009&#39;, &#39;g=d&#39;, &#39;a=1&#39;, &#39;b=8&#39;, &#39;c=2006&#39;, &#39;ignore=.csv&#39;]</span>

<span class="sd">In [60]: import urllib</span>

<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;\</span>

<span class="sd">In [133]: import numpy.random</span>

<span class="sd">@suppress</span>
<span class="sd">In [134]: numpy.random.seed(2358)</span>

<span class="sd">@doctest</span>
<span class="sd">In [135]: numpy.random.rand(10,2)</span>
<span class="sd">Out[135]:</span>
<span class="sd">array([[ 0.64524308,  0.59943846],</span>
<span class="sd">       [ 0.47102322,  0.8715456 ],</span>
<span class="sd">       [ 0.29370834,  0.74776844],</span>
<span class="sd">       [ 0.99539577,  0.1313423 ],</span>
<span class="sd">       [ 0.16250302,  0.21103583],</span>
<span class="sd">       [ 0.81626524,  0.1312433 ],</span>
<span class="sd">       [ 0.67338089,  0.72302393],</span>
<span class="sd">       [ 0.7566368 ,  0.07033696],</span>
<span class="sd">       [ 0.22591016,  0.77731835],</span>
<span class="sd">       [ 0.0072729 ,  0.34273127]])</span>

<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>

    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">In [106]: print x</span>
<span class="sd">jdh</span>

<span class="sd">In [109]: for i in range(10):</span>
<span class="sd">   .....:     print i</span>
<span class="sd">   .....:</span>
<span class="sd">   .....:</span>
<span class="sd">0</span>
<span class="sd">1</span>
<span class="sd">2</span>
<span class="sd">3</span>
<span class="sd">4</span>
<span class="sd">5</span>
<span class="sd">6</span>
<span class="sd">7</span>
<span class="sd">8</span>
<span class="sd">9</span>
<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">In [144]: from pylab import *</span>

<span class="sd">In [145]: ion()</span>

<span class="sd"># use a semicolon to suppress the output</span>
<span class="sd">@savefig test_hist.png width=4in</span>
<span class="sd">In [151]: hist(np.random.randn(10000), 100);</span>


<span class="sd">@savefig test_plot.png width=4in</span>
<span class="sd">In [151]: plot(np.random.randn(10000), &#39;o&#39;);</span>
<span class="sd">   &quot;&quot;&quot;</span><span class="p">,</span>

        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># use a semicolon to suppress the output</span>
<span class="sd">In [151]: plt.clf()</span>

<span class="sd">@savefig plot_simple.png width=4in</span>
<span class="sd">In [151]: plot([1,2,3])</span>

<span class="sd">@savefig hist_simple.png width=4in</span>
<span class="sd">In [151]: hist(np.random.randn(10000), 100);</span>

<span class="sd">&quot;&quot;&quot;</span><span class="p">,</span>
     <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># update the current fig</span>
<span class="sd">In [151]: ylabel(&#39;number&#39;)</span>

<span class="sd">In [152]: title(&#39;normal distribution&#39;)</span>


<span class="sd">@savefig hist_with_text.png</span>
<span class="sd">In [153]: grid(True)</span>

<span class="sd">@doctest float</span>
<span class="sd">In [154]: 0.1 + 0.2</span>
<span class="sd">Out[154]: 0.3</span>

<span class="sd">@doctest float</span>
<span class="sd">In [155]: np.arange(16).reshape(4,4)</span>
<span class="sd">Out[155]:</span>
<span class="sd">array([[ 0,  1,  2,  3],</span>
<span class="sd">       [ 4,  5,  6,  7],</span>
<span class="sd">       [ 8,  9, 10, 11],</span>
<span class="sd">       [12, 13, 14, 15]])</span>

<span class="sd">In [1]: x = np.arange(16, dtype=float).reshape(4,4)</span>

<span class="sd">In [2]: x[0,0] = np.inf</span>

<span class="sd">In [3]: x[0,1] = np.nan</span>

<span class="sd">@doctest float</span>
<span class="sd">In [4]: x</span>
<span class="sd">Out[4]:</span>
<span class="sd">array([[ inf,  nan,   2.,   3.],</span>
<span class="sd">       [  4.,   5.,   6.,   7.],</span>
<span class="sd">       [  8.,   9.,  10.,  11.],</span>
<span class="sd">       [ 12.,  13.,  14.,  15.]])</span>


<span class="sd">        &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="c1"># skip local-file depending first example:</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="n">examples</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1">#ipython_directive.DEBUG = True  # dbg</span>
    <span class="c1">#options = dict(suppress=True)  # dbg</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">IPythonDirective</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                          <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">content_offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">block_text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">state_machine</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                          <span class="p">)</span>

<span class="c1"># Run test suite as a script</span>
<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s1">&#39;_static&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s1">&#39;_static&#39;</span><span class="p">)</span>
    <span class="n">test</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;All OK? Check figures in _static/&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>

<h3><a href="../../../index.html">Table of Contents</a></h3>

<div>&nbsp;</div>
<div id="sidebartoc">
<p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ipython_keybindings.html">Keybindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../extensions.html">Extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jobcontrol.html">Job Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../exceptions.html">Customized Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinxext.html">IPython Sphinx Directive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev.html">Developers Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lexer.html">New IPython Console Lexer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../startup/index.html">IPython Shell Initialization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../startup/rehashx.html">01_rehashx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../startup/easy_import.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">04_easy_import</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../startup/ipython-logger.html">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../startup/help_helpers.html">06_Help_Helpers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../startup/aliases.html">System Aliases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../startup/41_numpy.html"><code class="docutils literal notranslate"><span class="pre">41_numpy_init</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../startup/42_pandas.html"><code class="docutils literal notranslate"><span class="pre">42_pandas_init</span></code> module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../startup/sysexcept.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">50_sysexception</span></code> module</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../util.html">General Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../jupyter.html">Jupyter Suite</a></li>
</ul>



</div>



        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Dynamic IPython</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
      Last updated on Sep 29, 2019.
    </div>
  </body>
</html>