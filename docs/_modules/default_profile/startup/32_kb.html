
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>default_profile.startup.32_kb &#8212; Dynamic IPython</title>
    
    <link rel="stylesheet" href="../../../_static/scrolls.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/theme_extras.js"></script>
    <link rel="canonical" href="https://farisachugthai.github.io/dynamic-ipython/_modules/default_profile/startup/32_kb.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<!-- <link charset="utf-8" href="https://fonts.googleapis.com/css?family=Source+Code+Pro" media="screen" rel="stylesheet" type="text/css" /> -->
<!-- <link charset="utf-8" href="https://fonts.googleapis.com/css?family=Source+Code+Pro:regular,italic,bold,bolditalic" media="screen" rel="stylesheet" type="text/css" /> -->
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>Dynamic IPython --- IPython Extensions</title>
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style type="text/css">
    /* CSS styles */
    /* Example by Matthias Benkort at http://codepen.io/KtorZ/pen/ZOzdqG */
    @import url(
      https://fonts.googleapis.com/css?family=Roboto:400,
      300,
      500,
      700
    );
    .wrapper {
      align-items: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .material-textfield {
      display: inline-block;
      height: 4rem;
      padding-top: 2rem;
    }
    .material-textfield input {
      background: none;
      border: none;
      box-sizing: border-box;
      display: block;
      font-family: Roboto, Arial, sans-serif;
      font-size: 1rem;
      padding: 0.25rem 0.1rem;
      width: 100%;
    }
    .material-textfield input:invalid {
      box-shadow: none;
    }
    .material-textfield input:focus {
      outline: none;
    }
    .material-textfield label {
      display: inline-block;
      font-family: Roboto, Arial, sans-serif;
      font-size: 0;
      pointer-events: none;
      position: relative;
      text-transform: uppercase;
      width: 100%;
    }
    .material-textfield label::before {
      content: attr(data-content);
      position: relative;
      transition: all 0.2s ease;
      will-change: font-size, top;
    }
    .material-textfield label::after {
      bottom: 0.9rem;
      content: "";
      height: 0.3rem;
      left: 50%;
      position: absolute;
      transition: all 0.2s ease;
      width: 0;
      will-change: width, left;
    }
    .material-textfield label::before,
    .material-textfield input[required]:focus ~ label::before {
      font-size: 0.75rem;
      top: -3.25rem;
    }
    .material-textfield input:focus ~ label::after {
      left: 0%;
      width: 100%;
    }
    .material-textfield input:invalid ~ label::before {
      font-size: 1rem;
      top: -2rem;
    }

    .material-textfield.blue input {
      border-bottom: 0.1rem solid #03a9f4;
      color: #0275a8;
    }
    .material-textfield.blue label::after {
      background: #03a9f4;
    }
    .material-textfield.blue label::before,
    .material-textfield.blue input[required]:focus ~ label::before {
      color: #47c4fd;
    }
    .material-textfield.blue input:invalid ~ label::before {
      color: #03a9f4;
    }

    .material-textfield.red input {
      border-bottom: 0.1rem solid #f44336;
      color: #d2190b;
    }
    .material-textfield.red label::after {
      background: #f44336;
    }
    .material-textfield.red label::before,
    .material-textfield.red input[required]:focus ~ label::before {
      color: #f8877f;
    }
    .material-textfield.red input:invalid ~ label::before {
      color: #f44336;
    }
  </style>
</head>

  </head><body>
  <link rel="stylesheet" href="../_static/style.css" /> 

    <div id="content">
      <div class="header">
        <h1 class="heading"><a href="../../../index.html"
          title="back to the documentation overview"><span>default_profile.startup.32_kb</span></a></h1>
      </div>
      <div class="relnav" role="navigation" aria-label="related navigation">
        <a href="#">default_profile.startup.32_kb</a>
      </div>
      <div id="contentwrapper">
        <div role="main">
        
<h1>Source code for default_profile.startup.32_kb</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Effectively me rewriting Prompt Toolkits keybindings handlers.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">reprlib</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">UserList</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">IPython.core.getipython</span> <span class="kn">import</span> <span class="n">get_ipython</span>

<span class="kn">from</span> <span class="nn">prompt_toolkit.cache</span> <span class="kn">import</span> <span class="n">SimpleCache</span>
<span class="kn">from</span> <span class="nn">prompt_toolkit.document</span> <span class="kn">import</span> <span class="n">Document</span>
<span class="kn">from</span> <span class="nn">prompt_toolkit.filters</span> <span class="kn">import</span> <span class="n">ViInsertMode</span>
<span class="kn">from</span> <span class="nn">prompt_toolkit.key_binding.defaults</span> <span class="kn">import</span> <span class="n">load_key_bindings</span>
<span class="kn">from</span> <span class="nn">prompt_toolkit.key_binding</span> <span class="kn">import</span> <span class="n">merge_key_bindings</span>
<span class="kn">from</span> <span class="nn">prompt_toolkit.key_binding.bindings.auto_suggest</span> <span class="kn">import</span> <span class="n">load_auto_suggest_bindings</span>
<span class="kn">from</span> <span class="nn">prompt_toolkit.key_binding.bindings.vi</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">load_vi_bindings</span><span class="p">,</span>
    <span class="n">load_vi_search_bindings</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">prompt_toolkit.key_binding.key_bindings</span> <span class="kn">import</span> <span class="n">KeyBindings</span><span class="p">,</span> <span class="n">ConditionalKeyBindings</span>
<span class="kn">from</span> <span class="nn">prompt_toolkit.keys</span> <span class="kn">import</span> <span class="n">Keys</span>

<span class="kn">from</span> <span class="nn">default_profile.startup.ptoolkit</span> <span class="kn">import</span> <span class="n">create_searching_keybindings</span>


<div class="viewcode-block" id="KeyBindingsManager"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager">[docs]</a><span class="k">class</span> <span class="nc">KeyBindingsManager</span><span class="p">(</span><span class="n">UserList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object to make working with keybindings easier.</span>

<span class="sd">    Subclasses UserList with a list of Keys and their handlers.</span>
<span class="sd">    By defining dunders, the collection of keybindings are much</span>
<span class="sd">    easier to work with.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KeyBindingsManager.__init__"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kb : `KeyBindings`</span>
<span class="sd">            Any KeyBindings you wanna throw us right off the bat.</span>
<span class="sd">            Handling this is gonna be hard unfortunately.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">shell</span> <span class="ow">or</span> <span class="n">get_ipython</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;pt_app&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">pt_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">key_bindings</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;pt_cli&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">pt_cli</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">key_bindings_registry</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="n">kb</span>

        <span class="c1"># So this should cover both IPython and pt aps that don&#39;t have self.shell set!</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="n">load_key_bindings</span><span class="p">()</span>
        <span class="c1"># idk what this is but pt requires it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_bindings_for_keys_cache</span> <span class="o">=</span> <span class="n">SimpleCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_bindings_starting_with_keys_cache</span> <span class="o">=</span> <span class="n">SimpleCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__version</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># For cache invalidation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2">&gt;: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">bindings</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">another_one</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Honestly not sure if this returns anything.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">add_binding</span><span class="p">(</span><span class="n">another_one</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">another_one</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">another_one</span><span class="p">)</span>

<div class="viewcode-block" id="KeyBindingsManager.add"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">another_one</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">another_one</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">bindings</span><span class="p">)</span>

<div class="viewcode-block" id="KeyBindingsManager.len"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager.len">[docs]</a>    <span class="k">def</span> <span class="nf">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__repr_pretty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
        <span class="c1"># I don&#39;t know why it has that call signature</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">:&gt; - </span><span class="si">{</span><span class="n">reprlib</span><span class="o">.</span><span class="n">recursive_repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">bindings</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">bindings</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

<div class="viewcode-block" id="KeyBindingsManager.bindings"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager.bindings">[docs]</a>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bindings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make the *kb* attributes bindings visible at the top level.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">bindings</span></div>

<div class="viewcode-block" id="KeyBindingsManager.call_iadd"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager.call_iadd">[docs]</a>    <span class="nd">@bindings</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">call_iadd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__iadd__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__version</span>

    <span class="nd">@_version</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">_clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_bindings_for_keys_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_bindings_starting_with_keys_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="KeyBindingsManager.get_keys"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager.get_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Dude don&#39;t define the vars inside the for loop</span>
        <span class="c1"># It&#39;s easier to segregate them at the top and then work with them</span>
        <span class="n">any_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">binding</span><span class="o">.</span><span class="n">keys</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">binding</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">Keys</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">Keys</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
                        <span class="n">any_count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">any_count</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

        <span class="c1"># Place bindings that have more &#39;Any&#39; occurrences in them at the end.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="o">-</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span></div>

<div class="viewcode-block" id="KeyBindingsManager.get_bindings_for_keys"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager.get_bindings_for_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_bindings_for_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of key bindings that can handle this key.</span>

<span class="sd">        (This return also inactive bindings, so the `filter` still has to be</span>
<span class="sd">        called, for checking it.)</span>

<span class="sd">        :param keys: tuple of keys.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bindings_for_keys_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">get</span><span class="p">)</span></div>

<div class="viewcode-block" id="KeyBindingsManager.get_bindings_starting_with_keys"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager.get_bindings_starting_with_keys">[docs]</a>    <span class="k">def</span> <span class="nf">get_bindings_starting_with_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of key bindings that handle a sequence starting with `keys`.</span>

<span class="sd">        (It does only return bindings for which the sequences are</span>
<span class="sd">        longer than `keys`. And like `get_bindings_for_keys`, it also includes</span>
<span class="sd">        inactive bindings.)</span>

<span class="sd">        :param keys: tuple of keys.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">get</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">keys</span><span class="p">):</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">Keys</span><span class="o">.</span><span class="n">Any</span><span class="p">:</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_bindings_starting_with_keys_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">get</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__sizeof__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Unfortunately I&#39;ve added so much to this class that it might be necessary to check</span>
        <span class="c1"># how big ano object is now</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="n">__sizeof__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>

<div class="viewcode-block" id="KeyBindingsManager.get"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.KeyBindingsManager.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
        <span class="c1"># TODO:</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="ApplicationKB"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.ApplicationKB">[docs]</a><span class="k">class</span> <span class="nc">ApplicationKB</span><span class="p">(</span><span class="n">KeyBindingsManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Functionally the exact same thing except now we&#39;re bound to _ip.pt_app.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ApplicationKB.__init__"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.ApplicationKB.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span> <span class="n">shell</span> <span class="ow">or</span> <span class="n">get_ipython</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="n">kb</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="o">.</span><span class="n">pt_app</span><span class="o">.</span><span class="n">key_bindings</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kb</span> <span class="o">=</span> <span class="n">load_key_bindings</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">kb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kb</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HandlesMergedKB"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.HandlesMergedKB">[docs]</a><span class="k">class</span> <span class="nc">HandlesMergedKB</span><span class="p">(</span><span class="n">KeyBindingsManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;It might be easier to handle the insufferable discrepencies in implementation</span>
<span class="sd">    between _MergedKeyBindings and ConditionalKeyBindings through class attributes.</span>

<span class="sd">    .. todo::</span>
<span class="sd">        Unpacking the KeyBindings registry attribute.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">shell</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">shell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">shell</span><span class="p">,</span> <span class="s2">&quot;pt_app&quot;</span><span class="p">):</span>
            <span class="n">kb</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">pt_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">key_bindings</span>
            <span class="k">if</span> <span class="n">kb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kb</span> <span class="o">=</span> <span class="n">load_key_bindings</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># todo</span></div>
                <span class="c1"># if isinstance(kb, _MergedKeyBindings):</span>
                <span class="c1">#     for i in kb.registries:</span>
                <span class="c1">#         unpack(i)</span>


<div class="viewcode-block" id="Documented"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.Documented">[docs]</a><span class="k">class</span> <span class="nc">Documented</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;I&#39;ll admit this subclass doesn&#39;t exist for much of a reason.</span>

<span class="sd">    However, it&#39;s a LOT easier to work with classes with their dunders defined.</span>

<span class="sd">    Implement the basics for a class to be considered a sequence IE len and iter.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_position</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></div>


<div class="viewcode-block" id="custom_keybindings"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.custom_keybindings">[docs]</a><span class="k">def</span> <span class="nf">custom_keybindings</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">KeyBindings</span><span class="p">:</span>

    <span class="n">kb</span> <span class="o">=</span> <span class="n">KeyBindings</span><span class="p">()</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">kb</span><span class="o">.</span><span class="n">add</span>

    <span class="c1"># Add custom key binding for PDB.</span>
    <span class="c1"># holy hell this is genius. py3.7 just got breakpoint but this wouldve been a great addition to my ipy conf</span>
    <span class="nd">@handle</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ControlB</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pdb_snippet</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pressing Control-B will insert `pdb.set_trace`.&quot;&quot;&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">current_buffer</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">import pdb; pdb.set_trace()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">ControlE</span><span class="p">,</span> <span class="n">Keys</span><span class="o">.</span><span class="n">ControlE</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">exec_line</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Typing ControlE twice should also execute the current command. (Alternative for Meta-Enter.)&quot;&quot;&quot;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">current_buffer</span>
        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">accept_action</span><span class="o">.</span><span class="n">is_returnable</span><span class="p">:</span>
            <span class="n">b</span><span class="o">.</span><span class="n">accept_action</span><span class="o">.</span><span class="n">validate_and_handle</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">cli</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">normal_mode</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Map &#39;jj&#39; to Escape.&quot;&quot;&quot;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">input_processor</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">KeyPress</span><span class="p">(</span><span class="n">Keys</span><span class="o">.</span><span class="n">Escape</span><span class="p">))</span>

    <span class="c1"># Custom key binding for some simple autocorrection while typing.</span>
    <span class="c1"># TODO: Observe how much this slows stuff down because if its a quick lookup then you could add your autocorrect.vim</span>
    <span class="n">corrections</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;impotr&quot;</span><span class="p">:</span> <span class="s2">&quot;import&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pritn&quot;</span><span class="p">:</span> <span class="s2">&quot;print&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">autocorrection</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When a space is pressed. Check &amp; correct word before cursor.&quot;&quot;&quot;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">cli</span><span class="o">.</span><span class="n">current_buffer</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">get_word_before_cursor</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">corrections</span><span class="p">:</span>
                <span class="n">b</span><span class="o">.</span><span class="n">delete_before_cursor</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
                <span class="n">b</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="n">corrections</span><span class="p">[</span><span class="n">w</span><span class="p">])</span>

        <span class="n">b</span><span class="o">.</span><span class="n">insert_text</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ConditionalKeyBindings</span><span class="p">(</span><span class="n">kb</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">ViInsertMode</span><span class="p">())</span></div>


<div class="viewcode-block" id="determine_which_pt_attribute"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.determine_which_pt_attribute">[docs]</a><span class="k">def</span> <span class="nf">determine_which_pt_attribute</span><span class="p">():</span>

    <span class="n">_ip</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>
    <span class="c1"># IPython &lt; 7.0</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_ip</span><span class="p">,</span> <span class="s1">&#39;pt_cli&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_ip</span><span class="o">.</span><span class="n">pt_cli</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">key_bindings_registry</span>
    <span class="c1"># IPython &gt;= 7.0</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_ip</span><span class="p">,</span> <span class="s1">&#39;pt_app&#39;</span><span class="p">):</span>
        <span class="c1"># Here&#39;s one that might blow your mind.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">_ip</span><span class="o">.</span><span class="n">pt_app</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>  <span class="c1"># ran into this while running pytest.</span>
            <span class="c1"># If you start IPython from something like pytest i guess it starts</span>
            <span class="c1"># the machinery with a few parts missing...I don&#39;t know.</span>

        <span class="k">return</span> <span class="n">_ip</span><span class="o">.</span><span class="n">pt_app</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">key_bindings</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">ipykernel.zmqshell</span> <span class="kn">import</span> <span class="n">ZMQInteractiveShell</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
            <span class="n">ZMQInteractiveShell</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Jupyter QTConsole</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_ip</span><span class="p">,</span> <span class="n">ZMQInteractiveShell</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span></div>

<div class="viewcode-block" id="create_kb"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.create_kb">[docs]</a><span class="k">def</span> <span class="nf">create_kb</span><span class="p">():</span>

    <span class="c1"># Honestly I&#39;m wary to do this but let&#39;s go for it</span>
    <span class="k">if</span> <span class="n">get_ipython</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">pre_existing_keys</span> <span class="o">=</span> <span class="n">determine_which_pt_attribute</span><span class="p">()</span>
    <span class="n">all_kb</span> <span class="o">=</span> <span class="n">merge_key_bindings</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">pre_existing_keys</span><span class="p">,</span>
            <span class="n">load_vi_bindings</span><span class="p">(),</span>
            <span class="n">load_vi_search_bindings</span><span class="p">(),</span>
            <span class="n">load_auto_suggest_bindings</span><span class="p">(),</span>  <span class="c1"># these stopped getting added when i did this</span>
            <span class="n">create_searching_keybindings</span><span class="p">(),</span>
            <span class="n">custom_keybindings</span><span class="p">(),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">all_kb</span></div>

<div class="viewcode-block" id="flatten_kb"><a class="viewcode-back" href="../../../startup/prompt_toolkit.html#default_profile.startup.32_kb.flatten_kb">[docs]</a><span class="k">def</span> <span class="nf">flatten_kb</span><span class="p">(</span><span class="n">merge</span><span class="p">):</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merge</span><span class="o">.</span><span class="n">_bindings2</span><span class="o">.</span><span class="n">bindings</span><span class="p">))</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="k">return</span> <span class="n">merge</span><span class="o">.</span><span class="n">_bindings2</span><span class="o">.</span><span class="n">bindings</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">merged_kb</span> <span class="o">=</span> <span class="n">create_kb</span><span class="p">()</span>
    <span class="n">kb_we_want</span> <span class="o">=</span> <span class="n">flatten_kb</span><span class="p">(</span><span class="n">merged_kb</span><span class="p">)</span>
    <span class="n">current_kb</span> <span class="o">=</span> <span class="n">determine_which_pt_attribute</span><span class="p">()</span>
    <span class="n">current_kb</span> <span class="o">=</span> <span class="n">kb_we_want</span>
</pre></div>

        </div>
      </div>
    </div>

    <div class="footer" role="contentinfo">
      Last updated on Mar 15, 2020.
    </div>
  </body>
</html>