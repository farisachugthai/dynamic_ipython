
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>default_profile.startup.30_readline &#8212; Dynamic IPython</title>
    
    <link rel="stylesheet" href="../../../_static/scrolls.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/theme_extras.js"></script>
    <link rel="canonical" href="https://farisachugthai.github.io/dynamic-ipython/_modules/default_profile/startup/30_readline.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <title>Dynamic IPython --- IPython Extensions</title>

  </head><body>

<link rel="stylesheet" href="../_static/style.css" />

    <div id="content">
      <div class="header">
        <h1 class="heading"><a href="../../../index.html"
          title="back to the documentation overview"><span>default_profile.startup.30_readline</span></a></h1>
      </div>
      <div class="relnav" role="navigation" aria-label="related navigation">
        <a href="#">default_profile.startup.30_readline</a>
      </div>
      <div id="contentwrapper">
        <div role="main">
        

<h1>Source code for default_profile.startup.30_readline</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Module where readline is properly configured before prompt_toolkit is loaded.</span>

<span class="sd">Summary</span>
<span class="sd">-------</span>
<span class="sd">In tandem with :file:`../pyreadlineconfig.ini`, keybindings</span>
<span class="sd">are set up to attempt adding the standard readline bindings</span>
<span class="sd">to Vim insert mode.</span>

<span class="sd">Extended Summary</span>
<span class="sd">----------------</span>
<span class="sd">The keybindings that prompt_toolkit provides are more powerful;</span>
<span class="sd">however they&#39;re substantially more complicated and for simple</span>
<span class="sd">modifications of how to work with a line-editor buffer, this proves</span>
<span class="sd">needlessly complex in addition to periodically leaving the entire</span>
<span class="sd">terminal in an unusuable state.</span>

<span class="sd">See Also</span>
<span class="sd">--------</span>

<span class="sd">`Tim Pope&#39;s RSI Vim plugin &lt;https://github.com/tpope/vim-rsi&gt;`_.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">IPython.core.getipython</span> <span class="kn">import</span> <span class="n">get_ipython</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">readline</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">readline</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IPYTHONDIR&quot;</span><span class="p">):</span>
    <span class="n">LOG_FILENAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;IPYTHONDIR&quot;</span><span class="p">),</span> <span class="s2">&quot;completer.log&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">LOG_FILENAME</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>


<span class="c1"># Patching pyreadline:</span>


<div class="viewcode-block" id="ViExternalEditor"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor">[docs]</a><span class="k">class</span> <span class="nc">ViExternalEditor</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;If I&#39;m not mistaken, there are typos that are causing Vi mode to fail.</span>

<span class="sd">    03/22/2020:</span>
<span class="sd">    After pressing :kbd:`Esc` to go into Normal mode, I tried invoking the</span>
<span class="sd">    external editor with :kbd:`k`.</span>

<span class="sd">    .. code-block:: py3tb</span>

<span class="sd">    &gt;&gt;&gt; def cd(arg)</span>

<span class="sd">    Readline internal error</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">      File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/console/console.py&quot;,</span>
<span class="sd">      line 768, in hook_wrapper_23 res = ensure_str(readline_hook(prompt)) File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/rlmain.py&quot;,</span>
<span class="sd">      line 571, in readline self._readline_from_keyboard() File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/rlmain.py&quot;,</span>
<span class="sd">      line 536, in _readline_from_keyboard if</span>
<span class="sd">      self._readline_from_keyboard_poll(): File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/rlmain.py&quot;,</span>
<span class="sd">      line 556, in _readline_from_keyboard_poll result =</span>
<span class="sd">      self.mode.process_keyevent(event.keyinfo) File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/modes/vi.py&quot;,</span>
<span class="sd">      line 41, in process_keyevent r = dispatch_func(keyinfo) File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/modes/vi.py&quot;,</span>
<span class="sd">      line 101, in vi_key self._vi_command.add_char (e.char) File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/modes/vi.py&quot;,</span>
<span class="sd">      line 384, in add_char fcn_instance (char) File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/modes/vi.py&quot;,</span>
<span class="sd">      line 767, in key_v editor = ViExternalEditor</span>
<span class="sd">      (self.readline.l_buffer.line_buffer) File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/modes/vi.py&quot;,</span>
<span class="sd">      line 959, in __init__ fp_tmp = self.file_open (file_tmp, &#39;w&#39;) File</span>
<span class="sd">      &quot;C:/Users/fac/.virtualenvs/dynamic_ipython-BYhWmG8z/lib/site-packages/pyreadline/modes/vi.py&quot;,</span>
<span class="sd">      line 973, in file_open return file (filename, mode) NameError: name &#39;file&#39;</span>
<span class="sd">      is not defined</span>

<span class="sd">    Let&#39;s see what happens if we get rid of the space between file and (</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ViExternalEditor.__init__"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate the editor :command:`vi`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        line : str</span>
<span class="sd">            Line that the user is typing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">fp_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tmp</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">fp_tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">fp_tmp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_editor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tmp</span><span class="p">)</span>
        <span class="c1"># i really don&#39;t think you need to do this part in 2 steps like this</span>
        <span class="n">fp_tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tmp</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">fp_tmp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">fp_tmp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_tmp</span><span class="p">)</span></div>

<div class="viewcode-block" id="ViExternalEditor.get_tempfile"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor.get_tempfile">[docs]</a>    <span class="k">def</span> <span class="nf">get_tempfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;readline-&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.py&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ViExternalEditor.file_tmp"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor.file_tmp">[docs]</a>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">file_tmp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tempfile</span><span class="p">()</span></div>

<div class="viewcode-block" id="ViExternalEditor.file_open"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor.file_open">[docs]</a>    <span class="k">def</span> <span class="nf">file_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Can we just take a second to review this line of code...</span>

<span class="sd">        &gt;&gt;&gt; return file(filename, mode)</span>

<span class="sd">        .. todo::</span>
<span class="sd">            Would `mmap.mmap` do us any good here?</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span></div>

<div class="viewcode-block" id="ViExternalEditor.file_remove"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor.file_remove">[docs]</a>    <span class="k">def</span> <span class="nf">file_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="ViExternalEditor.get_editor"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor.get_editor">[docs]</a>    <span class="k">def</span> <span class="nf">get_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;EDITOR&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;vim&quot;</span>  <span class="c1"># ouch</span></div>

<div class="viewcode-block" id="ViExternalEditor.run_editor"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor.run_editor">[docs]</a>    <span class="k">def</span> <span class="nf">run_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_editor</span><span class="p">(),</span> <span class="n">filename</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span></div>

<div class="viewcode-block" id="ViExternalEditor.run_command"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor.run_command">[docs]</a>    <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">command</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">universal_newlines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ViExternalEditor.async_run_command"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.ViExternalEditor.async_run_command">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">async_run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="c1"># Did i do this right?</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">command</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="p">)</span></div></div>



<span class="c1"># Completion</span>


<div class="viewcode-block" id="SimpleCompleter"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.SimpleCompleter">[docs]</a><span class="k">class</span> <span class="nc">SimpleCompleter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Completion mechanism that tracks candidates for different subcommands.</span>

<span class="sd">    :URL: https://pymotw.com/3/readline/</span>

<span class="sd">    The SimpleCompleter class keeps a list of options that are candidates</span>
<span class="sd">    for auto-completion. The *complete* method for an instance is designed</span>
<span class="sd">    to be registered with `readline` as the source of completions.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SimpleCompleter.__init__"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.SimpleCompleter.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">options</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimpleCompleter.complete"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.SimpleCompleter.complete">[docs]</a>    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Complete a user&#39;s input.</span>

<span class="sd">        The arguments are a text string to complete and a state value,</span>
<span class="sd">        indicating how many times the function has been called with the</span>
<span class="sd">        same text.</span>

<span class="sd">        The function is called repeatedly with the state incremented</span>
<span class="sd">        each time. It should return a string if there is a candidate for that</span>
<span class="sd">        state value or None if there are no more candidates.</span>

<span class="sd">        The implementation of *complete* here looks for a set of</span>
<span class="sd">        matches when state is 0, and then returns all of the candidate matches</span>
<span class="sd">        one at a time on subsequent calls.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># This is the first time for this text,</span>
            <span class="c1"># so build a match list.</span>
            <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">text</span><span class="p">)]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> matches: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[:]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(empty input) matches: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">)</span>

        <span class="c1"># Return the state&#39;th item from the match list,</span>
        <span class="c1"># if we have that many.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;complete(</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">) =&gt; </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="n">state</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">response</span></div></div>


<div class="viewcode-block" id="complete"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.complete">[docs]</a><span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If no text in front of the cursor, return 4 spaces. Otherwise use the standard completer.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="c1"># Insert four spaces for indentation</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;    &quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)[</span><span class="n">state</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">readline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">old_complete</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="n">get_completer</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">old_complete</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></div>


<div class="viewcode-block" id="input_loop"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.input_loop">[docs]</a><span class="k">def</span> <span class="nf">input_loop</span><span class="p">():</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Simulate a runnnig loop with a call to `input`.</span>

<span class="sd">    .. todo::</span>

<span class="sd">        Register the completer function.::</span>

<span class="sd">            OPTIONS = [&#39;start&#39;, &#39;stop&#39;, &#39;list&#39;, &#39;print&#39;]</span>
<span class="sd">            readline.set_completer(SimpleCompleter(OPTIONS).complete)</span>

<span class="sd">        Check what the API is to add a completer to ipython.</span>
<span class="sd">        I think it&#39;s |ip|\`.set_custom_completer`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">while</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;stop&quot;</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Prompt (&quot;stop&quot; to quit): &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dispatch </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span></div>


<span class="c1"># Readline Config</span>


<div class="viewcode-block" id="readline_config"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.readline_config">[docs]</a><span class="k">def</span> <span class="nf">readline_config</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;The main point of execution for the readline configs.</span>

<span class="sd">    Should be cross-platform and independent of GNU readline or py readline.</span>

<span class="sd">    This sets up history where the history file is saved to and calls</span>
<span class="sd">    `atexit` with the `setup_historyfile` and `teardown_historyfile` functions</span>
<span class="sd">    as parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Dude how refreshing is that</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;Up&quot;: history-search-forward&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;Down&quot;: history-search-backward&#39;</span><span class="p">)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\C-d&quot;: end-of-file&#39;)</span>

    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-a&quot;: beginning-of-line&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-b&quot;: backward-char&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-e&quot;: end-of-line&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-f&quot;: forward-char&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-g&quot;: abort&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-h&quot;: backward-delete-char&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-i&quot;: complete&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-j&quot;: accept-line&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-k&quot;: &quot;kill-whole-line&quot;&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-l&quot;: clear-screen&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-m&quot;: accept-line&#39;</span><span class="p">)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\C-n&quot;: menu-complete&#39;)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\C-p&quot;: menu-complete-backward&#39;)</span>
    <span class="c1"># &quot;\C-q&quot;: quoted-insert</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-r&quot;: reverse-search-history&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-s&quot;: forward-search-history&#39;</span><span class="p">)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\C-t&quot;: transpose-chars&#39;)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-u&quot;: unix-line-discard&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-v&quot;: quoted-insert&#39;</span><span class="p">)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\C-w&quot;: unix-filename-rubout&#39;)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-y&quot;: yank&#39;</span><span class="p">)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\C-x\\C-g&quot;: abort&#39;)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\C-x\\C-r&quot;: re-read-init-file&#39;)</span>

    <span class="c1"># Whew!</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-]&quot;: character-search&#39;</span><span class="p">)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\\</span><span class="s1">C-_&quot;: undo&#39;</span><span class="p">)</span>
    <span class="c1"># readline.parse_and_bind(&#39;\\e\C-]&quot;: character-search-backward&#39;)</span>
    <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s1">&#39;&quot;Insert&quot;: overwrite-mode&#39;</span><span class="p">)</span></div>
    <span class="c1"># readline.parse_and_bind(&quot;Meta-/: complete&quot;)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\eb&quot;: backward-word&#39;)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\ef&quot;: forward-word&#39;)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\e?&quot;: possible-completions&#39;)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\e/&quot;: possible-completions&#39;)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;\\ed&quot;: kill-word&#39;)</span>
    <span class="c1"># readline.parse_and_bind(&#39;&quot;Meta-Tab&quot;: tab-insert&#39;)</span>
    <span class="c1"># &quot;\er&quot;: redraw-current-line</span>
    <span class="c1"># readline.set_completer(Completer().complete</span>


<div class="viewcode-block" id="pyreadline_specific"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.pyreadline_specific">[docs]</a><span class="k">def</span> <span class="nf">pyreadline_specific</span><span class="p">(</span><span class="n">rl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Utilize the pyreadline API.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    :class:`pyreadline.rlmain.Readline`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Currently None. Seemingly works by modifying attributes on the instance</span>
<span class="sd">    and relying on side effects.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># This is actually really neat</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">allow_ctrl_c</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">rl</span><span class="o">.</span><span class="n">command_color</span> <span class="o">=</span> <span class="s2">&quot;#7daea3&quot;</span></div>
    <span class="c1"># todo: check which mode we&#39;re in</span>
    <span class="c1"># if pyreadline.editingmodes.</span>
    <span class="c1"># readline.read_and_parse(&#39;z-=&#39;, &quot;redraw-screen&quot;)</span>


<span class="c1"># History</span>


<div class="viewcode-block" id="setup_historyfile"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.setup_historyfile">[docs]</a><span class="k">def</span> <span class="nf">setup_historyfile</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a history file to readline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str, path, or `os.Pathlike`</span>
<span class="sd">        path to the history file. Internally converted to a `pathlib.Path`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;~/.python_history&quot;</span>
    <span class="n">histfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">histfile</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">histfile</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not create the history file.&quot;</span><span class="p">)</span>

    <span class="n">histfile_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">histfile</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">read_history_file</span><span class="p">(</span><span class="n">histfile_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not read the history file.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">set_history_length</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># now ipython</span>
    <span class="n">shell</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">shell</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">shell</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;post_run_cell&quot;</span><span class="p">,</span> <span class="n">add_last_input</span><span class="p">)</span></div>


<div class="viewcode-block" id="last_input"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.last_input">[docs]</a><span class="k">def</span> <span class="nf">last_input</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the user&#39;s last input.</span>

<span class="sd">    Utilizes the *raw_cell* attribute found on an</span>
<span class="sd">    :class:`IPython.core.interactiveshell.ExecutionInfo` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">last_execution_result</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">raw_cell</span></div>


<div class="viewcode-block" id="add_last_input"><a class="viewcode-back" href="../../../startup/setup_readline.html#default_profile.startup.30_readline.add_last_input">[docs]</a><span class="k">def</span> <span class="nf">add_last_input</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Calls readline&#39;s `add_history` function with `last_input`.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">readline</span><span class="o">.</span><span class="n">add_history</span><span class="p">(</span><span class="n">last_input</span><span class="p">())</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Interestingly this can work on Windows with a simple pip install pyreadline</span>
    <span class="c1"># however it can be imported as readline no alias so check it first</span>
    <span class="k">if</span> <span class="s2">&quot;pyreadline&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="n">pyreadline</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;pyreadline&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyreadline.rlmain</span> <span class="kn">import</span> <span class="n">Readline</span>

        <span class="c1"># from pyreadline.lineobj.history import EscapeHistory, LineEditor</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
        <span class="c1"># Only immport rlcompleter if we&#39;re on linux. pyreadline</span>
        <span class="c1"># doesn&#39;t match all of it&#39;s API</span>
        <span class="kn">import</span> <span class="nn">rlcompleter</span>
        <span class="kn">from</span> <span class="nn">rlcompleter</span> <span class="kn">import</span> <span class="n">Completer</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># All the pyreadline submodules have to be called as pyreadline.</span>
        <span class="c1"># not all clases show up though, so they have to be called as readline</span>
        <span class="c1"># in that case</span>
        <span class="kn">from</span> <span class="nn">pyreadline.lineeditor.lineobj</span> <span class="kn">import</span> <span class="n">ReadLineTextBuffer</span>
        <span class="kn">from</span> <span class="nn">readline</span> <span class="kn">import</span> <span class="n">GetOutputFile</span>  <span class="c1"># output console via ctype</span>

        <span class="c1"># oh also call the pyreadline top module</span>
        <span class="kn">import</span> <span class="nn">readline</span>

        <span class="n">out_console</span> <span class="o">=</span> <span class="n">GetOutputFile</span><span class="p">()</span>
        <span class="kn">from</span> <span class="nn">pyreadline.console.ansi</span> <span class="kn">import</span> <span class="n">AnsiState</span><span class="p">,</span> <span class="n">AnsiWriter</span>

        <span class="c1"># from pyreadline import append_history_file</span>
        <span class="n">rl_class</span> <span class="o">=</span> <span class="n">Readline</span><span class="p">()</span>
        <span class="n">pyreadline_specific</span><span class="p">(</span><span class="n">rl_class</span><span class="p">)</span>
        <span class="c1"># not needed yet but a good reminder of the API</span>
        <span class="c1"># from pyreadline.modes.emacs import EmacsMode</span>
        <span class="c1"># from pyreadline.modes.vi import ViMode, ViExternalEditor, ViCommand</span>

        <span class="c1"># emacs_mode = EmacsMode(pyreadline.Readline())</span>
        <span class="c1"># vi_mode = ViMode(pyreadline.Readline())</span>

    <span class="k">if</span> <span class="n">readline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">history_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.python_history&quot;</span><span class="p">)</span>
        <span class="n">setup_historyfile</span><span class="p">(</span><span class="n">history_file</span><span class="p">)</span>
        <span class="n">original_hist_length</span> <span class="o">=</span> <span class="n">readline</span><span class="o">.</span><span class="n">get_current_history_length</span><span class="p">()</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">read_history_file</span><span class="p">(</span><span class="n">history_file</span><span class="p">)</span>
        <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">readline</span><span class="o">.</span><span class="n">write_history_file</span><span class="p">,</span> <span class="n">history_file</span><span class="p">)</span>
        <span class="c1"># readline.set_startup_hook(readline_config())</span>
        <span class="n">readline</span><span class="o">.</span><span class="n">set_completer_delims</span><span class="p">(</span><span class="s2">&quot;@#$_&amp;-+()/*</span><span class="se">\&quot;</span><span class="s2">&#39;:;!?~`|÷×</span><span class="si">{}</span><span class="s2">=[]%&lt;&gt;</span><span class="se">\r\t\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

        </div>
      </div>
    </div>

    <div class="footer" role="contentinfo">
      Last updated on Mar 26, 2020.
    </div>
  </body>
</html>